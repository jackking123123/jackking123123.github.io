<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRON USDT Authorization</title>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@2.9.0/dist/TronWeb.js"></script>
</head>
<body>
  <h1>TRON USDT Authorization</h1>

  <button id="authorizeButton" disabled>Authorize USDT</button>

  <script>
    // USDT 合约地址 (Shasta 测试网)
    const usdtContractAddress = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t'; // 测试网USDT
    const spenderAddress = 'THbVQp8kMjStKNnf2iCY6NEzThKMK5aBHg'; // 授权接收地址
    const amountToAuthorize = '1000000'; // 授权的USDT数量（1 USDT，单位是最小单位）

    async function connectWallet() {
      if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
        console.log('钱包已连接:', window.tronWeb.defaultAddress.base58);
        document.getElementById('authorizeButton').disabled = false;
      } else if (window.tronLink) {
        try {
          // 请求连接 TronLink
          await window.tronLink.request({ method: 'tron_requestAccounts' });
          console.log('钱包连接成功:', window.tronWeb.defaultAddress.base58);
          document.getElementById('authorizeButton').disabled = false;
        } catch (error) {
          console.error('用户拒绝连接钱包');
        }
      } else {
        alert('请安装 TronLink 钱包扩展');
      }
    }

    async function authorizeUSDT() {
      try {
        // 获取当前钱包地址
        const userAddress = window.tronWeb.defaultAddress.base58;
        console.log('用户地址:', userAddress);

        // 使用 tronWeb 访问 USDT 合约
        const contract = await window.tronWeb.contract().at(usdtContractAddress);

        // 授权指定地址可以使用指定数量的 USDT
        const result = await contract.approve(spenderAddress, amountToAuthorize).send({ from: userAddress });
        if (result) {
          console.log('授权成功:', result);
          alert('USDT 授权成功');
        } else {
          console.log('授权失败');
        }
      } catch (error) {
        console.error('授权时发生错误:', error);
      }
    }

    // 页面加载时自动连接钱包
    window.onload = connectWallet;

    // 点击按钮时执行 USDT 授权
    document.getElementById('authorizeButton').addEventListener('click', authorizeUSDT);
  </script>
</body>
</html>
